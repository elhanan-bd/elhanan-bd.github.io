<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <title>Number Generator</title>
        <script>
            // Conf
            var number_of_participents = 350;
            var blacklist_numbers = [];  // [5, 200, 74]

            var colors = ['#E87C7C', '#6EFCFE', '#FCAB2E'];
            // End conf

            // Private conf

            var radius = 1000;
            var circle_x_offset = 50;
            var circle_y_offset = 200;
            var circle_parts = 60;
            var start_angle = 0;

            // End provate conf
        </script>
    </head>
    <body>
        <svg id="circle" width="100%" height="100%">
        </svg>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script>
            var circle_middle_x;
            var circle_middle_y;
            function create_circle(parent, radius, start_x, start_y, circle_parts, start_angle)
            {
                let len = (radius * 2 * Math.PI) / circle_parts;
                //circle_middle_x = start_x + Math.round(len / 2);
                circle_middle_x = start_x + (len / 2);
                circle_middle_y = start_y + radius;
                let angle_per_slice = 360 / circle_parts;
                let html_string = '';
                for (i = 0; i < circle_parts; ++i)
                {
                    // let d_str = `M${start},${start} A${radius},${radius} 0 0,1 ${start + Math.round(len)},${start} L${circle_middle_x},${circle_middle_y} L${start},${start}`;
                    //let d_str = `M${start_x},${start_y} A${radius},${radius} 0 0,1 ${start_x + Math.round(len)},${start_y} L${circle_middle_x},${circle_middle_y} L${start_x},${start_y}`;
                    let d_str = `M${start_x},${start_y} A${radius},${radius} 0 0,1 ${start_x + len},${start_y} L${circle_middle_x},${circle_middle_y} L${start_x},${start_y}`;
                    let path_html = `<path d="${d_str}" stroke="black" stroke-width="1" fill="${colors[i % colors.length]}"/>`;
                    let text_html = `<text x="${circle_middle_x}" y="${start_y + 50}">${values[i]}</text>`;
                    let curr_angle = i * angle_per_slice;
                    let g_meta_data = `angle="${curr_angle}" index="${i}" step="0" value_updated="0"`;
                    html_string += `<g ${g_meta_data} transform="rotate(${curr_angle} ${circle_middle_x} ${circle_middle_y})">${path_html}${text_html}</g>`;
                    //html_string += path_html;
                    //break;
                }
                let inner_circle_html = `<circle cx="${circle_middle_x}" cy="${circle_middle_y}" r="300" stroke="black" stroke-width="1" fill="white"/>`;

                let niddle_width = 40;
                let niddle_height = 60;
                let niddle_start_x = circle_middle_x;
                let niddle_start_y = start_y;

                let niddle_p1 = `${niddle_start_x - niddle_width / 2},${niddle_start_y - niddle_height / 2}`;
                let niddle_p2 = `${niddle_start_x + niddle_width / 2},${niddle_start_y - niddle_height / 2}`;
                let niddle_p3 = `${niddle_start_x},${niddle_start_y + niddle_height / 2}`;
                let niddle_html = `<path d="M${niddle_p1} L${niddle_p2} L${niddle_p3} L${niddle_p1}" fill="Red"/>`;
                let niddle_point_html = `<path id="niddle_point" d="M${niddle_p3} L${niddle_p3}" />`;
                parent.html(html_string + inner_circle_html + niddle_html + niddle_point_html);
            }

            function shuffle(array) {
                let currentIndex = array.length,  randomIndex;
              
                // While there remain elements to shuffle.
                while (currentIndex != 0) {
              
                  // Pick a remaining element.
                  randomIndex = Math.floor(Math.random() * currentIndex);
                  currentIndex--;
              
                  // And swap it with the current element.
                  [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
                }
              
                return array;
            }
            
            var values = [];
            var current_value_index = 0;

            var spin_inital_speed;
            var spin_speed = 0;
            var spin_slow_down;
            var circle = $('#circle');
            var spin_index;
            var spin_sleep;
            var index;

            circle.on('click', function () {
                if (spin_speed <= 0)
                {
                    spin_inital_speed = 20 + Math.random() * 20;
                    console.log("speed - " + spin_inital_speed);
                    spin_slow_down = 0.99;
                    spin_index = 0;
                    index = 0;

                    var spin_interval = setInterval(function () {
                        spin_index++;
                        $('g').each(function() {
                            let angle = parseFloat($(this).attr('angle'));
                            if (angle > 90 && angle <= 180 && $(this).attr('value_updated') == 0)
                            {
                                // set new value
                                let step = parseInt($(this).attr('step')) + 1;
                                new_value = values[(circle_parts + parseInt($(this).attr('index')) + step * circle_parts) % values.length];
                                //console.log(`Changing ${$(this).attr('index')} from ${$(this).find('text').text()} to ${new_value}`);
                                $(this).find('text').text(new_value);
                                $(this).attr('step', step + 1);
                                $(this).attr('value_updated', "1");
                            }
                            else if (angle > 180)
                            {
                                $(this).attr('value_updated', "0");
                            }
                            let new_angle = (angle + spin_speed) % 360;
                            $(this).attr('angle', new_angle).attr('transform', `rotate(${new_angle} ${circle_middle_x} ${circle_middle_y})`);
                        });
                        spin_speed = spin_inital_speed * Math.pow(spin_slow_down, index);
                        //console.log('speed', spin_speed);
                        index++;
                        if (spin_speed < 0.015)
                        {
                            spin_speed = 0;
                            clearInterval(spin_interval);
                            find_winner();
                        }
                    }, 15);
                }
                else {
                    spin_speed = 0;
                }
            });

            function find_winner()
            {
                let tie_angle = 360 / circle_parts / 2;  // 3

                $('g').each(function() {
                    let angle = parseFloat($(this).attr('angle'));
                    if (angle == tie_angle)
                    {
                        alert('TIE');
                    }
                    else if (angle < tie_angle || angle > (360 - tie_angle))
                    {
                        alert('Winner is ' + $(this).find('text').text());
                    }
                });
            }

            $( document ).ready(function() {
                // Shuffle values
                for (let i = 1; i <= number_of_participents; ++i)
                {
                    if (!blacklist_numbers.includes(i))
                    values.push(i);
                }
                // shuffle(values);

                create_circle(circle, radius, screen.width / 2 - circle_x_offset, circle_y_offset, circle_parts, start_angle);
                current_value_index = circle_parts;
            });
        </script>
    </body>
</html>